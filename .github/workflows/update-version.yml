---
name: Update Version

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch versions from uptime-kuma
        id: fetch-versions
        run: |
          # Fetch releases from GitHub API with authentication
          RELEASES=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/louislam/uptime-kuma/releases)

          # Check if API request was successful
          if [ -z "$RELEASES" ] || \
             echo "$RELEASES" | jq -e . >/dev/null 2>&1; then
            :
          else
            echo "Error: Failed to fetch releases from GitHub API"
            exit 1
          fi

          # Find latest stable version (non-prerelease, non-draft)
          LATEST_VERSION=$(echo "$RELEASES" | jq -r \
            '[.[] | select(.prerelease == false and .draft == false)] |
            .[0].tag_name // empty')

          # Find latest beta version (prerelease)
          BETA_VERSION=$(echo "$RELEASES" | jq -r \
            '[.[] | select(.prerelease == true and .draft == false)] |
            .[0].tag_name // empty')

          # Validate versions
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "Error: Could not find a stable release"
            exit 1
          fi

          if [ -z "$BETA_VERSION" ] || [ "$BETA_VERSION" = "null" ]; then
            echo "Warning: No beta release found, using current beta version"
            BETA_VERSION=$(jq -r '.beta' version.json)
          fi

          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "beta_version=$BETA_VERSION" >> $GITHUB_OUTPUT

          echo "Found versions - Latest: $LATEST_VERSION, Beta: $BETA_VERSION"

      - name: Update version.json
        id: update-version
        run: |
          # Read current version.json
          CURRENT_LATEST=$(jq -r '.latest' version.json)
          CURRENT_BETA=$(jq -r '.beta' version.json)

          # Get new versions from previous step
          NEW_LATEST="${{ steps.fetch-versions.outputs.latest_version }}"
          NEW_BETA="${{ steps.fetch-versions.outputs.beta_version }}"

          # Validate versions before updating
          if [ -z "$NEW_LATEST" ] || [ "$NEW_LATEST" = "null" ]; then
            echo "Error: Invalid latest version"
            exit 1
          fi

          if [ -z "$NEW_BETA" ] || [ "$NEW_BETA" = "null" ]; then
            echo "Error: Invalid beta version"
            exit 1
          fi

          echo "Current versions - Latest: $CURRENT_LATEST, Beta: $CURRENT_BETA"
          echo "New versions - Latest: $NEW_LATEST, Beta: $NEW_BETA"

          # Update version.json using jq (only latest and beta, not slow)
          jq --arg latest "$NEW_LATEST" --arg beta "$NEW_BETA" \
            '.latest = $latest | .beta = $beta' \
            version.json > version.json.tmp

          mv version.json.tmp version.json

          # Check if there are changes
          if git diff --quiet version.json; then
            echo "No changes to version.json"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "version.json has been updated"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.update-version.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email \
            "github-actions[bot]@users.noreply.github.com"
          git add version.json
          git commit -m "Update latest and beta versions"
          git push
